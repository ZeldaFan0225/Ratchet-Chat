generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String          @id @default(uuid()) @db.Uuid
  username                   String          @unique
  kdf_salt                   String
  kdf_iterations             Int
  srp_salt                   String?
  srp_verifier               String?
  public_identity_key        String
  public_transport_key       String
  encrypted_identity_key     String
  encrypted_identity_iv      String
  encrypted_transport_key    String
  encrypted_transport_iv     String
  show_typing_indicator      Boolean         @default(true)
  send_read_receipts         Boolean         @default(true)
  created_at                 DateTime        @default(now())
  incoming_queue             IncomingQueue[] @relation("IncomingRecipient")
  vault_messages             MessageVault[]  @relation("VaultOwner")
  sessions                   Session[]       @relation("UserSessions")
}

model Session {
  id              String   @id @default(uuid()) @db.Uuid
  user_id         String   @db.Uuid
  token_hash      String   @unique
  device_info     String?
  ip_address      String?
  created_at      DateTime @default(now())
  last_active_at  DateTime @default(now())
  expires_at      DateTime

  user            User     @relation("UserSessions", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([expires_at])
  @@index([token_hash])
}

model IncomingQueue {
  id             String   @id @default(uuid()) @db.Uuid
  recipient_id   String   @db.Uuid
  sender_handle  String?
  message_id     String?  @db.Uuid
  event_type     String   @default("message")
  reaction_emoji String?
  encrypted_blob String   @db.Text
  iv             String?
  created_at     DateTime @default(now())
  recipient      User     @relation("IncomingRecipient", fields: [recipient_id], references: [id], onDelete: Cascade)

  @@index([recipient_id])
  @@index([recipient_id, message_id, event_type, sender_handle])
}

model MessageVault {
  id                        String    @id @default(uuid()) @db.Uuid
  owner_id                  String    @db.Uuid
  peer_handle               String?
  original_sender_handle    String
  encrypted_blob            String    @db.Text
  iv                        String
  sender_signature_verified Boolean   @default(false)
  version                   Int       @default(0)
  created_at                DateTime  @default(now())
  updated_at                DateTime  @default(now()) @updatedAt
  deleted_at                DateTime?
  owner                     User      @relation("VaultOwner", fields: [owner_id], references: [id], onDelete: Cascade)

  @@index([owner_id, created_at])
  @@index([owner_id, updated_at])
  @@index([owner_id, id])
  @@index([owner_id, peer_handle])
}
