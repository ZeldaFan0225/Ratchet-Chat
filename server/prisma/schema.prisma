generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String              @id @default(uuid()) @db.Uuid
  username                   String              @unique
  kdf_salt                   String
  kdf_iterations             Int
  opaque_password_file       Bytes?
  public_identity_key        String
  public_transport_key       String
  encrypted_identity_key     String
  encrypted_identity_iv      String
  encrypted_transport_key    String
  encrypted_transport_iv     String
  show_typing_indicator      Boolean             @default(true)
  send_read_receipts         Boolean             @default(true)
  display_name               String?
  display_name_visibility    String              @default("public") // "public" or "hidden"
  avatar_filename            String?
  avatar_visibility          String              @default("public") // "public" or "hidden"
  encrypted_block_list       String?             @db.Text
  encrypted_block_list_iv    String?
  encrypted_contacts         String?             @db.Text
  encrypted_contacts_iv      String?
  // Privacy settings (encrypted client-side, server only stores blob)
  encrypted_privacy_settings    String?          @db.Text
  encrypted_privacy_settings_iv String?
  // Muted conversations (encrypted client-side)
  encrypted_muted_conversations    String?       @db.Text
  encrypted_muted_conversations_iv String?
  // TOTP 2FA fields
  totp_enabled                  Boolean   @default(false)
  totp_secret                   String?   // Plaintext secret for server verification
  encrypted_totp_secret         String?   @db.Text  // Encrypted with master key (for client backup)
  encrypted_totp_secret_iv      String?
  totp_verified_at              DateTime?
  created_at                 DateTime            @default(now())
  incoming_queue             IncomingQueue[]     @relation("IncomingRecipient")
  vault_messages             MessageVault[]      @relation("VaultOwner")
  sessions                   Session[]           @relation("UserSessions")
  passkeys                   PasskeyCredential[] @relation("UserPasskeys")
  totp_recovery_codes        TotpRecoveryCode[]  @relation("UserTotpRecoveryCodes")
}

model PasskeyCredential {
  id            String   @id @default(uuid()) @db.Uuid
  user_id       String   @db.Uuid
  credential_id String   @unique
  public_key    Bytes
  sign_count    Int      @default(0)
  transports    String[]
  name          String?
  created_at    DateTime @default(now())
  last_used_at  DateTime @default(now())

  user          User     @relation("UserPasskeys", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model TotpRecoveryCode {
  id         String    @id @default(uuid()) @db.Uuid
  user_id    String    @db.Uuid
  code_hash  String    // SHA-256 hash of the recovery code
  used_at    DateTime?
  created_at DateTime  @default(now())

  user       User      @relation("UserTotpRecoveryCodes", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([code_hash])
}

model Session {
  id                 String             @id @default(uuid()) @db.Uuid
  user_id            String             @db.Uuid
  token_hash         String             @unique
  device_info        String?
  ip_address         String?
  created_at         DateTime           @default(now())
  last_active_at     DateTime           @default(now())
  expires_at         DateTime

  user               User               @relation("UserSessions", fields: [user_id], references: [id], onDelete: Cascade)
  push_subscriptions PushSubscription[] @relation("SessionPushSubscriptions")

  @@index([user_id])
  @@index([expires_at])
  @@index([token_hash])
}

model PushSubscription {
  id           String   @id @default(uuid()) @db.Uuid
  session_id   String   @db.Uuid
  endpoint     String   @unique
  p256dh_key   String
  auth_key     String
  user_agent   String?
  created_at   DateTime @default(now())
  last_used_at DateTime @default(now())

  session      Session  @relation("SessionPushSubscriptions", fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id])
}

model IncomingQueue {
  id             String   @id @default(uuid()) @db.Uuid
  recipient_id   String   @db.Uuid
  sender_handle  String?
  message_id     String?  @db.Uuid
  // Note: event_type and reaction_emoji removed for privacy - server should not know what actions users perform
  encrypted_blob String   @db.Text
  iv             String?
  created_at     DateTime @default(now())
  recipient      User     @relation("IncomingRecipient", fields: [recipient_id], references: [id], onDelete: Cascade)

  @@index([recipient_id])
  @@index([recipient_id, sender_handle])
}

model MessageVault {
  id                        String    @id @default(uuid()) @db.Uuid
  owner_id                  String    @db.Uuid
  peer_handle               String?
  original_sender_handle    String
  encrypted_blob            String    @db.Text
  iv                        String
  sender_signature_verified Boolean   @default(false)
  version                   Int       @default(0)
  created_at                DateTime  @default(now())
  updated_at                DateTime  @default(now()) @updatedAt
  deleted_at                DateTime?
  owner                     User      @relation("VaultOwner", fields: [owner_id], references: [id], onDelete: Cascade)

  @@index([owner_id, created_at])
  @@index([owner_id, updated_at])
  @@index([owner_id, id])
  @@index([owner_id, peer_handle])
}
